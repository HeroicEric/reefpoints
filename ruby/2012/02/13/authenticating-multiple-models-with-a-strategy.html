<!DOCTYPE html><html><head><title>Authenticating multiple models with a strategy</title><link href="/stylesheets/all-82c87bf5.css" media="screen" rel="stylesheet" type="text/css" /><script src="/javascripts/all-c96a81f7.js" type="text/javascript"></script><meta content='NO-CACHE' http-equiv='CACHE-CONTROL'><meta content='DockYard is a Ruby on Rails, PostgreSQL, and, Ember.js, web / mobile application development software consultancy based in Boston, MA.' namer='description'><meta content='ruby on rails, rails, ruby, ruby on rails training, ruby application development, ruby on rails application development, ember application development, ember.js application development, software application development, web, web application development, mobile, mobile application development, ios, ios application development, iphone, iphone application development, android, android application development, postgres, startups, enterprise, Boston, MA, Massachusetts, for hire' name='keywords'><meta content='web development, mobile development, startups, enterprise, ruby on rails, rails, ruby, ruby on rails training, Boston, for hire' name='keywords'><meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0' name='viewport'><meta charset='utf-8'><meta content='DockYard.com - Using the Strategy Pattern to clean up multiple login paths' name='description'><meta content='bcardarella' name='twitter:creator'><meta content='summary' name='twitter:card'><meta content='@DockYard' name='twitter:site'><meta content='http://reefpoints.dockyard.com/ruby/2012/02/13/authenticating-multiple-models-with-a-strategy.html' name='twitter:url'><meta content='Authenticating multiple models with a strategy' name='twitter:title'><meta content='Using the Strategy Pattern to clean up multiple login paths' name='twitter:description'><link href='//cloud.typography.com/6496052/702882/css/fonts.css' rel='stylesheet' type='text/css'><link href='http://dockyard.com/humans.txt' rel='author'><link href='/favicon-573a5e34.png' rel='shortcut icon' type='image/x-icon'><link href='/favicon-573a5e34.png' rel='icon' type='image/x-icon'><link href='/apple-touch-icon.png' rel='apple-touch-icon'><link href='/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'><script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24185112-2']);
    _gaq.push(['_trackPageview']);
  
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
<!--
                                             ..
                                           .O.
                                       .:OO.
                                      :OOO.
                                    :OOO:.
                         ...      :OOOO:
                   ..ZOOOOOOOOO..OZ.O.
                   OOOOOOOOOOOOOOOOI
                  OOOOOOOOOOOOOOOOI,
                 OOOOOOOO. .OOOOOOOO:
                 OOOOOOOO   OOOOOOOOO:
                OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO
                OOOOOO?:   .OOOOOOOOO
               .OOOOO      OOOOOOOOOO
,OO ZO~        OOOOO,     OOOOOOOOOO+
 OOOOO.        OOOOO     OOOOOOOOOOO+
  OOO?        OOOOO     .OOOOOOOOOOO:
   OOO,      OOOOO.    .OOOOOOOOOOOO
    OOOOOOOOOOOOO.    .OOOOOOOOOOOO.
     OOOOOOOOOOOO.  .OOOOOOOOOOOOO.
      8OOOOOOOOOOOOOOOOOOOOOOOODO:
         :OOOOOOOOOOOOOOOOOOOO::

--></head><body class='ruby ruby_2012 ruby_2012_02 ruby_2012_02_13 ruby_2012_02_13_authenticating-multiple-models-with-a-strategy'><header><div class='extended-header-wrap has-border--bottom'><div class='l-wrap--wide'><nav class='extended-nav has-border--bottom'><a class='extended-nav--logo' data-icon='⌂' href='http://www.dockyard.com/'><span class='is-hidden'>Home</span></a><a class='extended-nav--close' data-icon='X'><span class='is-hidden'>Close</span></a><div class='extended-nav__items-wrap'><div class='extended-nav__items'><a class='extended-nav__item' href='http://www.dockyard.com/team'>Our Team</a><a class='extended-nav__item' href='http://www.dockyard.com/community'>Community</a><a class='extended-nav__item active' href='/'>Blog</a><a class='extended-nav__item' href='http://www.dockyard.com/hire-us'>Hire Us</a></div></div></nav><nav class='work-nav'><p>Selected Work</p><a class='work-nav-item' href='http://www.dockyard.com/work/credit-card-reviews'><h4 class='work-nav-item__title'>Credit Card Reviews</h4><p class='work-nav-item__desc'>Credit card advice from real people.</p></a><a class='work-nav-item' href='http://www.dockyard.com/work/coachup'><h4 class='work-nav-item__title'>CoachUp</h4><p class='work-nav-item__desc'>You should be training. Right now.</p></a><a class='work-nav-item' href='http://www.dockyard.com/work/askthem'><h4 class='work-nav-item__title'>AskThem</h4><p class='work-nav-item__desc'>Ask officials questions on city, state, and federal levels.</p></a><a class='work-nav-item' href='http://www.dockyard.com/work/beacon-hill-blitz'><h4 class='work-nav-item__title'>Beacon Hill Blitz</h4><p class='work-nav-item__desc'>How technology helped repeal the #TechTax.</p></a></nav></div></div><nav class='main-nav-wrap has-border--bottom'><div class='main-nav l-wrap--wide'><a class='logo' href='http://www.dockyard.com/'>DockYard</a><a class='club-sandwich' data-icon='☰'><span class='is-hidden'>Navigation</span></a></div></nav></header><div class='push--header'></div><div class='l-wrap'><a class='logo--reefpoints' href='/'>ReefPoints</a><div class='search-wrap'><form class='search' data-url='/'><input class='search__input' id='search' name='search' placeholder='Search all posts' type='text' value=''><button class='search__submit' href='/'></button></form></div><nav class='blog-topnav'><a class="blog-topnav__item " href="/">Posts</a><a class="blog-topnav__item " href="/tags.html">Tags</a><a class="blog-topnav__item " href="/authors.html">Authors</a></nav><div class='post-wrap--no-comments'><aside class='post__metas--post l-post__metas'><a class='icon' data-icon='#' href='http://twitter.com/bcardarella' target='_blank'><span class='is-hidden'>Twitter</span></a><a class='icon' data-icon='★' href='https://github.com/bcardarella' target='_blank'><span class='is-hidden'>GitHub</span></a><a class="post__meta--author" href="/authors/brian-cardarella.html">Brian Cardarella</a><p class='post__meta--date'>13 Feb 2012</p><p class='post__meta--tags'><a class="post__meta--tag" href="/tags/ruby.html">Ruby (35)</a> <a class="post__meta--tag" href="/tags/ruby-on-rails.html">Ruby on Rails (25)</a> <a class="post__meta--tag" href="/tags/design-patterns.html">Design Patterns (6)</a></p></aside><div class='post l-post'><h1 class='post__title'>Authenticating multiple models with a strategy</h1><current_page class='post__content'><p>A current project requires that there be multiple models that can sign
in and each one must use the same sign in form. The original
<code>SessionsController#create</code> action looked like the following:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre><span class="keyword">def</span> <span class="function">create</span>
  <span class="keyword">if</span> user = (<span class="constant">Owner</span>.authenticate(params[<span class="symbol">:user</span>]) || <span class="constant">Employee</span>.authenticate(params[<span class="symbol">:user</span>]))
    session[<span class="symbol">:user_id</span>]    = user.id
    session[<span class="symbol">:user_class</span>] = user.class
    redirect_to dashboard_path
  <span class="keyword">else</span>
    render <span class="symbol">:action</span> =&gt; <span class="symbol">:new</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>We&#39;re using <code>has_secure_password</code> and rolling our own authentication.
Considering that, the above was good enough. But... looking down
the line for this app it is likely we will have to support authentication
for more than just two models on the same form. I also don&#39;t like having
logic in my controllers. So I decided to break this logic out and I
chose the <a href="http://en.wikipedia.org/wiki/Strategy_pattern">Strategy Pattern</a> to help.</p>

<p>I like putting all of my strategies into
<code>app/strategies</code>. This required me to add this directory to the Rails
<code>autoload_paths</code>. Simply open up <code>config/application.rb</code>
(not necessary in Rails 3.1+, thanks Artur Roszczyk)</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>config.autoload_paths += <span class="string"><span class="delimiter">%W(</span><span class="inline"><span class="inline-delimiter">#{</span>config.root<span class="inline-delimiter">}</span></span><span class="content">/app/strategies</span><span class="delimiter">)</span></span>
</pre></td>
</tr></table>
</div></div>
<p>Next I wrote up a simple spec, thankfully I already had the logic from
the controller so there wasn&#39;t much work to be done here. This went into
<code>spec/strategies/authentication_strategy_spec.rb</code></p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
19
<strong>20</strong>
21
22
23
24
25
26
27
28
29
<strong>30</strong>
31
32
33
34
35
36
37
38
39
</pre></td>
  <td class="code"><pre>require <span class="string"><span class="delimiter">'</span><span class="content">spec_helper</span><span class="delimiter">'</span></span>

describe <span class="constant">AuthenticationStrategy</span> <span class="keyword">do</span>
  context <span class="string"><span class="delimiter">'</span><span class="content">authenticating an owner</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
    let(<span class="symbol">:owner</span>) { mock(<span class="string"><span class="delimiter">'</span><span class="content">Owner</span><span class="delimiter">'</span></span>) }
    before <span class="keyword">do</span>
      owner.stubs(<span class="symbol">:authenticate</span>).returns(owner)
      <span class="constant">Owner</span>.stubs(<span class="symbol">:where</span>).returns([owner])
    <span class="keyword">end</span>
    it <span class="string"><span class="delimiter">'</span><span class="content">returns an owner</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
      <span class="constant">AuthenticationStrategy</span>.run(<span class="symbol">:email</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">owner@example.com</span><span class="delimiter">'</span></span>, <span class="symbol">:password</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">password</span><span class="delimiter">'</span></span>).should eq owner
    <span class="keyword">end</span>
  <span class="keyword">end</span>

  context <span class="string"><span class="delimiter">'</span><span class="content">authenticating an employee</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
    let(<span class="symbol">:employee</span>) { mock(<span class="string"><span class="delimiter">'</span><span class="content">Employee</span><span class="delimiter">'</span></span>) }
    before <span class="keyword">do</span>
      employee.stubs(<span class="symbol">:authenticate</span>).returns(employee)
      <span class="constant">Employee</span>.stubs(<span class="symbol">:where</span>).returns([employee])
    <span class="keyword">end</span>
    it <span class="string"><span class="delimiter">'</span><span class="content">returns an employee</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
      <span class="constant">AuthenticationStrategy</span>.run(<span class="symbol">:email</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">employee@example.com</span><span class="delimiter">'</span></span>, <span class="symbol">:password</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">password</span><span class="delimiter">'</span></span>).should eq employee
    <span class="keyword">end</span>

  <span class="keyword">end</span>

  describe <span class="string"><span class="delimiter">'</span><span class="content">failing to authenticate</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
    context <span class="string"><span class="delimiter">'</span><span class="content">with no attributes</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
      it <span class="string"><span class="delimiter">'</span><span class="content">returns nil</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
        <span class="constant">AuthenticationStrategy</span>.run.should be_nil
      <span class="keyword">end</span>
    <span class="keyword">end</span>
    context <span class="string"><span class="delimiter">'</span><span class="content">with no match for owner or employee</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
      it <span class="string"><span class="delimiter">'</span><span class="content">returns nil</span><span class="delimiter">'</span></span> <span class="keyword">do</span>
        <span class="constant">AuthenticationStrategy</span>.run(<span class="symbol">:email</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">test@example.com</span><span class="delimiter">'</span></span>, <span class="symbol">:password</span> =&gt; <span class="string"><span class="delimiter">'</span><span class="content">password</span><span class="delimiter">'</span></span>).should be_nil
      <span class="keyword">end</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>Now it was time to make these specs green! The strategy file goes into
<code>app/strategies/authentication_strategy.rb</code></p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">AuthenticationStrategy</span>
  <span class="keyword">def</span> <span class="predefined-constant">self</span>.<span class="function">run</span>(attributes = <span class="predefined-constant">nil</span>)
    <span class="keyword">return</span> <span class="predefined-constant">nil</span> <span class="keyword">if</span> (attributes.nil? || attributes[<span class="symbol">:email</span>].blank? || attributes[<span class="symbol">:password</span>].blank?)
    <span class="constant">Owner</span>.authenticate(attributes) || <span class="constant">Employee</span>.authenticate(attributes)
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>And finally to clean up the controller</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre><span class="keyword">def</span> <span class="function">create</span>
  <span class="keyword">if</span> user = <span class="constant">AuthenticationStrategy</span>.run(params[<span class="symbol">:user</span>])
    session[<span class="symbol">:user_id</span>]    = user.id
    session[<span class="symbol">:user_class</span>] = user.class
    redirect_to dashboard_path
  <span class="keyword">else</span>
   render <span class="symbol">:action</span> =&gt; <span class="symbol">:new</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>In the end this may appear to be more work than is necessary. Keep in
mind that app requirements will expand to support more models. The wins should be obvious
considering that context. If the requirements grow to 5 or 6 models perhaps at that point it makes sense to
actually break the authentication up into <a href="http://en.wikipedia.org/wiki/Identity_management">Identities</a> with a <a href="http://guides.rubyonrails.org/association_basics.html#polymorphic-associations">polymorphic
association</a> to the different models.
But we&#39;ll cross that road when we get there.</p>
<div class='post__share'><div class='post__share__links'><a class='twitter-share-button' data-url='http://reefpoints.dockyard.com/ruby/2012/02/13/authenticating-multiple-models-with-a-strategy.html' data-via='DockYard' href='https://twitter.com/share'>Tweet</a><script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='//platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','twitter-wjs');
</script><div class='g-plusone' data-href='#' data-size='medium' data-width='100'></div><script>
  (function() {var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;po.src = 'https://apis.google.com/js/plusone.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);})();
</script></div><p>This article is brought to you by <a class='text-link' href='http://www.dockyard.com/'>DockYard</a>. If you see an issue, please send a <a href='https://github.com/dockyard/reefpoints/blob/master/source/posts/', class='text-link post__issue', target: '_blank'>pull request</a> to contribute.</p><a class='button--post' href='http://www.dockyard.com/hire-us'>Hire Us</a></div></current_page></div></div><div class='post__comments'><div id='disqus_thread'></div><script>
  var disqus_shortname = 'reefpoints';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script><noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus</a>.</noscript></noscript></div><script>
  var path = window.location.pathname.split('/').reverse();
  var postname = path[0].split('.');
  var change = postname[0] + '.md';
  var newpath = 'https://github.com/dockyard/reefpoints/blob/master/source/posts/' + path[3] + '-' + path[2] + '-' + path[1] + '-' + change
  $('.post__issue').attr('href', newpath);
  
  $('.search').submit(function(event) {
    event.preventDefault();
    window.location = $(this).data('url') + '#q=' + $('.search__input').val();
  });
</script>
<h2 class='nothin'>Your search returned no results. Perhaps you should try again.</h2></div><div class='push--big'></div><footer><div class='l-wrap'><div class='footer-group'><h3 class='footer-group__title'>EVENTS</h3><nav><a class='footer__event' href='http://wickedgoodruby.com/' target='_blank'><div class='footer__event--wgr'></div><h4 class='footer-title'>Wicked Good Ruby Conf</h4></a><a class='footer__event' href='http://www.meetup.com/Boston-Ember-js/' target='_blank'><div class='footer__event--ember'></div><h4 class='footer-title'>Boston Ember.js Meetup</h4></a><a class='footer__event' href='http://www.meetup.com/uxboston/' target='_blank'><div class='footer__event--ux'></div><h4 class='footer-title'>UX Boston Meetup</h4></a><a class='footer__event' href='http://openhack.github.io/boston/' target='_blank'><div class='footer__event--openhack'></div><h4 class='footer-title'>OpenHack Boston</h4></a></nav></div><div class='footer-group'><a href='/'><h3 class='footer-group__title'>BLOG</h3></a><nav class='blog-nav--footer'><a class='blog-nav-item--footer' href='/2013/11/15/think.html'><h4 class='footer-title'>Think</h4><p class='footer-desc'>Don't do what others tell you to do without thinking about it</p></a><a class='blog-nav-item--footer' href='/2013/11/11/capybara-extensions.html'><h4 class='footer-title'>Introducing Capybara-Extensions</h4><p class='footer-desc'>Write more descriptive tests with additional finders and matchers for Capybara.</p></a><a class='blog-nav-item--footer' href='/2013/11/05/design-patterns-command-pattern.html'><h4 class='footer-title'>Design Patterns: The Command Pattern</h4><p class='footer-desc'>Exploring design patterns and their use cases</p></a></nav></div><div class='footer-group'><a href='/hire-us'><h3 class='footer-group__title'>CONTACT</h3></a><p class='footer-desc'>DockYard HQ is located in Boston. Stop in sometime and meet our team!</p><a class='footer-address has-border--top' href='https://www.google.com/maps/preview#!q=DockYard%2C+Tremont+Street+%23200%2C+Boston%2C+MA&amp;data=!4m15!2m14!1m13!1s0x89e37083512ceab3%3A0x1e657c639844318d!3m8!1m3!1d197180!2d-70.970284!3d42.31435!3m2!1i400!2i802!4f13.1!4m2!3d42.357236!4d-71.061077' target='_blank'><p class='footer-desc'>DockYard Inc.</p><p class='footer-desc'>101 Tremont Street</p><p class='footer-desc'>Suite 200</p><p class='footer-desc'>Boston, MA 02108</p></a><a class="text-link" href="http://www.dockyard.com/hire-us">Get in touch.</a><div class='footer-social has-border--top'><a class='social-nav-item' data-icon='#' href='https://twitter.com/dockyard' target='_blank'><span class='is-hidden'>Twitter</span></a><a class='social-nav-item' data-icon='★' href='https://github.com/dockyard' target='_blank'><span class='is-hidden'>GitHub</span></a><a class='social-nav-item' data-icon='✒' href='http://reefpoints.dockyard.com/atom.xml' target='_blank'><span class='is-hidden'>RSS</span></a></div></div></div></footer><audio class='foghorn' preload='auto' src='/sound/foghorn.mp3'></audio><script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'reefpoints'; // required: replace example with your forum shortname
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script></body></html>
