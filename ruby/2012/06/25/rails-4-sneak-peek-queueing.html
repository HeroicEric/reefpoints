<!DOCTYPE html><html><head><title>Rails 4.0 Sneak Peek: Queueing</title><link href="/stylesheets/all-6a5d8a6b.css" media="screen" rel="stylesheet" type="text/css" /><script src="/javascripts/all-d0af4672.js" type="text/javascript"></script><meta content='NO-CACHE' http-equiv='CACHE-CONTROL'><meta content='DockYard is a Ruby on Rails, PostgreSQL, and, Ember.js, web / mobile application development software consultancy based in Boston, MA.' namer='description'><meta content='ruby on rails, rails, ruby, ruby on rails training, ruby application development, ruby on rails application development, ember application development, ember.js application development, software application development, web, web application development, mobile, mobile application development, ios, ios application development, iphone, iphone application development, android, android application development, postgres, startups, enterprise, Boston, MA, Massachusetts, for hire' name='keywords'><meta content='web development, mobile development, startups, enterprise, ruby on rails, rails, ruby, ruby on rails training, Boston, for hire' name='keywords'><meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0' name='viewport'><meta content='DockYard.com - A look at the new Queueing API' name='description'><meta content='bcardarella' name='twitter:creator'><meta content='summary' name='twitter:card'><meta content='@DockYard' name='twitter:site'><meta content='http://reefpoints.dockyard.com/ruby/2012/06/25/rails-4-sneak-peek-queueing.html' name='twitter:url'><meta content='Rails 4.0 Sneak Peek: Queueing' name='twitter:title'><meta content='A look at the new Queueing API' name='twitter:description'><link href='http://dockyard.com/humans.txt' rel='author'><link href='/apple-touch-icon.png' rel='apple-touch-icon'><link href='/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'><script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24185112-2']);
    _gaq.push(['_trackPageview']);
  
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
<!--
                                                                    ..
                                                                 ,Z+O.
                                                              .OO.O..
                                                             OZ..O.
                                                         ..OO..87.
                                                        .O7O..O...
                                                      .O...Z~O.
                                                   .:Z~. ..Z..
                                                  +O.O   .8..
                                     ...       .OO.  O  O?.
                             ..ZOOOOOOOOOZOOO.ZOZ.   .OO..
                           .OOOOOOOOOOOOOOOOOO..Z.   $O.
                         .ZOOOOOOOOOOOOOOOOOO.  .O..O.
                        .ZOOOOOOOOOOOOOOOOOOOZ  .:O$.
                        OZOOOOOOOOOOO...OOOOOOOZ$ZO
                      ..OOOOOOOOOOOOO  .OOOOOOOOOOO..
                      .OOOOOOOOOOOOOOOOOOOOOOOOOOOOO.
                      .OOOOOOOOOOOOOOOOOOOOOOOOOOOOZ.
                      OOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.
                     .OOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.
                     :OOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.
                     ZOOOOOOOOOOOOOOOOOOOOOOOOOOOOOZ.
                     OOOOOOOOOOOOOOOOOOOOOOOOOOOO7OO.
                     ZOOOOOOOOOOOOOOOOOOOOOOOOOOOOOZ.
                     OOOOOOZOOOOOOOO.ZOOOOOOOOOOO7OO.
                     ZOOOOO.OOOOOOOO.OOOOOOOOOO.  OO.
...     ..           OOOOO.OOOOOOOO.OOOOOOOOO.   .O:
.OOZ...OOO.        ..OOOOO.OOOOOOO.OOOOOOOOZ.    .Z..
.OOOOOOOOO         .ZOOOOO.OOOOO..OOOOOOOO~      .Z
 .OOOOOOO.         .OOOOOO.OZZ..OOOOOOOOO.      .?O
  .OOOOOI.        .OOOOOOO..,ZOOOOOOOOOO..      .O.
   .OOOOZ.      ..ZOOOOOOOOOOOOOOOOOOOO~        .O.
   .OOOOO= .....ZOOOOOOOOOOOOOOOOOOOOOO.      ..O.
   ..OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOZ       .,OO.
    .ZOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.     ...OO..
     .OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.   ...OO.
     ..ZOOOOOOOOOOOOOOOOOOOOOOOOOOOO.... OZO..
      ...OOOOOOOOOOOOOOOOOOOOOOOOOOZOOOZO...
          .....~OOOOOOOOOOOOOOOOO:........
                ................
--></head><body id='blog'><header id='mobile-header'><div class='wrap'><a class='header-logo' href='/'>DockYard</a><div class='menu-button'></div></div><ul class='flexnav' data-breakpoint='481' id='mobile-nav'><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com'><span class='mobile-nav-icon fontello'>h</span><p class='main-nav-item'>Home</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com'><span class='mobile-nav-icon fontello'>w</span><p class='main-nav-item'>Work</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com'><span class='mobile-nav-icon fontello'>p</span><p class='main-nav-item'>Team</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com'><span class='mobile-nav-icon fontello'>c</span><p class='main-nav-item'>Community</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='/'><span class='mobile-nav-icon fontello'>b</span><p class='main-nav-item'>Blog</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com/hire-us'><span class='mobile-nav-icon fontello'>m</span><p class='main-nav-item'>Contact</p></a></li></ul></header><header id='site-header'><div class='wrap'><h1><a class='header-logo' href='http://dockyard.com'>DockYard</a></h1><ul class='main-nav'><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/work'>Work</a></li><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/team'>Team</a></li><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/community'>Community</a></li><li class='nav-work'><a class='main-nav-item current' href='/'>Blog</a></li><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/contact'>Contact</a></li></ul></div></header><section id='content'><section id='post'><aside class='post-metas-wrap'><ul class='post-metas'><li class='post-meta'><a class="post-author" href="/authors/brian-cardarella.html">Brian Cardarella</a></li><li class='post-meta'><span><a class='link link-in-post fontello' href='http://twitter.com/bcardarella' target='_blank'>t</a><a class='link link-in-post fontello' href='https://github.com/bcardarella' target='_blank'>g</a></span></li><li class='post-meta post-date'>25 Jun 2012</li></ul></aside><div class='post-div'><p class='post-meta post-tags'><a class="tag-link" href="/categories/ruby.html">Ruby (34)</a>, <a class="tag-link" href="/categories/ruby-on-rails.html">Ruby on Rails (25)</a><a class="tag-link" style="float: right" href="/categories.html">See all categories</a></p><div class='post-title-wrap'><h1 class='post-title'>Rails 4.0 Sneak Peek: Queueing</h1></div><current_page class='post-content'><p>Recently a <a href="https://github.com/rails/rails/commit/adff4a706a5d7ad18ef05303461e1a0d848bd662">queueing system was added to Rails</a>.
Let&#39;s dive in and see how to use it.</p>

<h2>Run, baby, run!</h2>

<p>The queueing API is very simple. You push an object on to the queue and
that object is expected to respond to a <code>run</code> method. Let&#39;s take a look:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">TestJob</span>
  <span class="keyword">def</span> <span class="function">run</span>
    puts <span class="string"><span class="delimiter">&quot;</span><span class="content">I am running!</span><span class="delimiter">&quot;</span></span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="constant">Rails</span>.queue.push(<span class="constant">TestJob</span>.new)
=&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">I am running!</span><span class="delimiter">&quot;</span></span>
</pre></td>
</tr></table>
</div></div>
<p>For most people, that is pretty much it. The queue is running in a
separate thread from the app thread, so your app shouldn&#39;t notice any
response impact from an expensive job.</p>

<p>The basic queue that comes with Rails is not a long-term solution. The
goal here is to establish a common API that more robust queueing systems
can plug themselves into. In most cases you shouldn&#39;t need to change any
of your app code if you want to switch from
<a href="https://github.com/defunkt/resque">Resque</a> to
<a href="https://github.com/mperham/sidekiq">Sidekiq</a>. You should take care that
the objects you are enqueing can be properly marshalled.</p>

<p>You can even write your own queue, let&#39;s take a look at the API of a
custom queue</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">MyQueue</span>
  <span class="keyword">def</span> <span class="function">push</span>(job)
    job.run
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>Then in your <code>application.rb</code></p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>config.queue = <span class="constant">MyQueue</span>
</pre></td>
</tr></table>
</div></div>
<p>This example is straight from the Rails test suite. This will define a
queue that does not run jobs asynchronously. As soon as the job is
pushed onto the queue it is run. Let&#39;s make an actual queue (without relying on
the Queue class)</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">MyQueue</span>
  <span class="keyword">def</span> <span class="function">initialize</span>
    <span class="instance-variable">@queue</span> = []
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function">push</span>(job)
    <span class="instance-variable">@queue</span>.push(job)
  <span class="keyword">end</span>

  <span class="keyword">def</span> <span class="function">pop</span>
    <span class="instance-variable">@queue</span>.pop
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>In this example we have implemented a simple queue. You will next need
to tell Rails&#39;s QueueConsumer to use this queue. You can do this in
<code>application.rb</code> with an initializer block:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
</pre></td>
  <td class="code"><pre>intializer <span class="string"><span class="delimiter">'</span><span class="content">start queue consumer</span><span class="delimiter">'</span></span> <span class="keyword">do</span> |app|
  app.queue_consumer = config.queue_consumer.start(app.queue)
  at_exit { app.queue.consumer.shutdown }
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>and if we now push to our new queue:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre><span class="constant">Rails</span>.queue.push(<span class="constant">TestJob</span>.new)
</pre></td>
</tr></table>
</div></div>
<p>...we get nothing. Why? Inspect the QueueConsumer:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre><span class="constant">Rails</span>.application.queue_consumer
=&gt; <span class="comment">#&lt;Rails::Queueing::ThreadedConsumer @queue=#&lt;MyQueue @queue=[]&gt;, @thread=#&lt;Thread dead&gt;&gt;</span>
</pre></td>
</tr></table>
</div></div>
<p>So you&#39;ll notice that the thread is <code>dead</code>. We can force the queue to
process by doing:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre><span class="constant">Rails</span>.application.queue_consumer.start
=&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">I am running!</span><span class="delimiter">&quot;</span></span>
</pre></td>
</tr></table>
</div></div>
<p>Let&#39;s back up to understand what is going on here. First we&#39;ll start by looking at <code>ThreadedConsumer#start</code></p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
</pre></td>
  <td class="code"><pre><span class="keyword">def</span> <span class="function">start</span>
  <span class="instance-variable">@thread</span> = <span class="constant">Thread</span>.new <span class="keyword">do</span>
    <span class="keyword">while</span> job = <span class="instance-variable">@queue</span>.pop
      <span class="keyword">begin</span>
        job.run
      <span class="keyword">rescue</span> <span class="constant">Exception</span> =&gt; e
        handle_exception e
      <span class="keyword">end</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
  <span class="predefined-constant">self</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>So this thread is only staying alive as long as the <code>@queue.pop</code> returns a truthy value.
It&#39;s not reasonable or us to keep shoving something into the queue, so let&#39;s see what is happening 
in <code>Queue#pop</code>. For this we&#39;ll look at Rubinius&#39; implementation</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
19
<strong>20</strong>
</pre></td>
  <td class="code"><pre><span class="comment"># Retrieves data from the queue.  If the queue is empty, the calling thread is</span>
<span class="comment"># suspended until data is pushed onto the queue.  If +non_block+ is true, the</span>
<span class="comment"># thread isn't suspended, and an exception is raised.</span>
<span class="comment">#</span>
<span class="keyword">def</span> <span class="function">pop</span>(non_block=<span class="predefined-constant">false</span>)
  <span class="keyword">while</span> <span class="predefined-constant">true</span>
    <span class="instance-variable">@mutex</span>.synchronize <span class="keyword">do</span>
      <span class="instance-variable">@waiting</span>.delete(<span class="constant">Thread</span>.current)
      <span class="keyword">if</span> <span class="instance-variable">@que</span>.empty?
        raise <span class="constant">ThreadError</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">queue empty</span><span class="delimiter">&quot;</span></span> <span class="keyword">if</span> non_block
        <span class="instance-variable">@waiting</span>.push <span class="constant">Thread</span>.current
        <span class="instance-variable">@resource</span>.wait(<span class="instance-variable">@mutex</span>)
      <span class="keyword">else</span>
        retval = <span class="instance-variable">@que</span>.shift
        <span class="instance-variable">@resource</span>.signal
        <span class="keyword">return</span> retval
      <span class="keyword">end</span>
    <span class="keyword">end</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>This now starts to make sense. <code>Queue#pop</code> is an infinite loop that will wait until it has
content before each iteration. Our simple <code>MyQueue</code> class would return <code>nil</code> when <code>ThreadConsumer#start</code>
is called because there is nothing in the queue and the thread would die. Even if we put something in
queue it would pop once, run the job, try to pop againg, then die.</p>

<p>For the sake of simplicity let&#39;s just have <code>MyQueue</code> inherit from
<code>Queue</code></p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre><span class="keyword">class</span> <span class="class">MyQueue</span> &lt; <span class="constant">Queue</span>
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>Now we can run</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre><span class="constant">Rails</span>.queue.push(<span class="constant">TestJob</span>.new)
=&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">I am running!</span><span class="delimiter">&quot;</span></span>
</pre></td>
</tr></table>
</div></div>
<p>The queue system in Rails 4.0 is a very simple solution, I&#39;m looking
forward to the release and the support for it to be added to many of the
leading background job processing libraries.</p>

<p>Keep in mind that as of this writing the master branch is still
versioned as &#39;beta&#39;. This API could change.</p>
</current_page><p class='issue'>See a problem with the current page? &nbsp;<a href='https://github.com/dockyard/reefpoints/blob/master/source/posts/' target='_blank'>Send a pull request to contribute, we'll happily accept!</a></p><section class='post-share'><h1>Like the current page? Please share!</h1><div class='social-button'><a class='twitter-share-button' data-url='http://reefpoints.dockyard.com/ruby/2012/06/25/rails-4-sneak-peek-queueing.html' data-via='DockYard' href='https://twitter.com/share'>Tweet</a></div><script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='//platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','twitter-wjs');
</script><div class='social-button'><div class='g-plusone' data-href='#' data-size='medium' data-width='100'></div><script>
  (function() {var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;po.src = 'https://apis.google.com/js/plusone.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);})();
</script></div></section><section id='post-comments'><div id='disqus_thread'></div><script>
  var disqus_shortname = 'reefpoints';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script><noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a></noscript></noscript></section></div></section><script>
  var path = window.location.pathname.split('/').reverse();
  var postname = path[0].split('.');
  var change = postname[0] + '.md';
  var newpath = 'https://github.com/dockyard/reefpoints/blob/master/source/posts/' + path[3] + '-' + path[2] + '-' + path[1] + '-' + change
  $('.issue a').attr('href', newpath);
</script>
</section><footer><ul class='footer-links'><li><a class='link link-in-footer fontello' href='https://github.com/DockYard' target='_blank'>g</a></li><li><a class='link link-in-footer fontello' href='https://twitter.com/DockYard' target='_blank'>t</a></li><li><a class='link link-in-footer fontello' href='http://reefpoints.dockyard.com/atom.xml' target='_blank'>r</a></li><li><a class='link link-in-footer fontello' href='http://dockyard.com/hire-us' target='_blank'>m</a></li></ul><form class='footer-form'><label class='footer-form-label'>Get in touch with us!</label><input class='footer-form-input' placeholder='Email' type='text'><button class='footer-form-submit fontello' href='http://dockyard.com/contact'>R</button></form><a class='footer-number' href='tel:855-362-5973'>(855) DOCK-YRD</a><p class='footer-copyright'>&copy; 2013 DockYard, LLC. All Rights Reserved.</p></footer><audio class='foghorn' preload='auto' src='/sound/foghorn.mp3'></audio><script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'reefpoints'; // required: replace example with your forum shortname
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script></body></html>
