<!DOCTYPE html><html><head><title>Our Continuous Integration Setup</title><link href="/stylesheets/all-2eea9150.css" media="screen" rel="stylesheet" type="text/css" /><script src="/javascripts/all-d0af4672.js" type="text/javascript"></script><meta content='NO-CACHE' http-equiv='CACHE-CONTROL'><meta content='DockYard is a Ruby on Rails, PostgreSQL, and, Ember.js, web / mobile application development software consultancy based in Boston, MA.' namer='description'><meta content='ruby on rails, rails, ruby, ruby on rails training, ruby application development, ruby on rails application development, ember application development, ember.js application development, software application development, web, web application development, mobile, mobile application development, ios, ios application development, iphone, iphone application development, android, android application development, postgres, startups, enterprise, Boston, MA, Massachusetts, for hire' name='keywords'><meta content='web development, mobile development, startups, enterprise, ruby on rails, rails, ruby, ruby on rails training, Boston, for hire' name='keywords'><meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0' name='viewport'><meta content='DockYard.com - What we are doing to keep our developers honest with their tests' name='description'><meta content='_danmcclain' name='twitter:creator'><meta content='summary' name='twitter:card'><meta content='@DockYard' name='twitter:site'><meta content='http://reefpoints.dockyard.com/ruby/2012/03/05/our-ci-setup.html' name='twitter:url'><meta content='Our Continuous Integration Setup' name='twitter:title'><meta content='What we are doing to keep our developers honest with their tests' name='twitter:description'><link href='http://dockyard.com/humans.txt' rel='author'><link href='/apple-touch-icon.png' rel='apple-touch-icon'><link href='/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'><script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24185112-2']);
    _gaq.push(['_trackPageview']);
  
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
<!--
                                                                    ..
                                                                 ,Z+O.
                                                              .OO.O..
                                                             OZ..O.
                                                         ..OO..87.
                                                        .O7O..O...
                                                      .O...Z~O.
                                                   .:Z~. ..Z..
                                                  +O.O   .8..
                                     ...       .OO.  O  O?.
                             ..ZOOOOOOOOOZOOO.ZOZ.   .OO..
                           .OOOOOOOOOOOOOOOOOO..Z.   $O.
                         .ZOOOOOOOOOOOOOOOOOO.  .O..O.
                        .ZOOOOOOOOOOOOOOOOOOOZ  .:O$.
                        OZOOOOOOOOOOO...OOOOOOOZ$ZO
                      ..OOOOOOOOOOOOO  .OOOOOOOOOOO..
                      .OOOOOOOOOOOOOOOOOOOOOOOOOOOOO.
                      .OOOOOOOOOOOOOOOOOOOOOOOOOOOOZ.
                      OOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.
                     .OOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.
                     :OOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.
                     ZOOOOOOOOOOOOOOOOOOOOOOOOOOOOOZ.
                     OOOOOOOOOOOOOOOOOOOOOOOOOOOO7OO.
                     ZOOOOOOOOOOOOOOOOOOOOOOOOOOOOOZ.
                     OOOOOOZOOOOOOOO.ZOOOOOOOOOOO7OO.
                     ZOOOOO.OOOOOOOO.OOOOOOOOOO.  OO.
...     ..           OOOOO.OOOOOOOO.OOOOOOOOO.   .O:
.OOZ...OOO.        ..OOOOO.OOOOOOO.OOOOOOOOZ.    .Z..
.OOOOOOOOO         .ZOOOOO.OOOOO..OOOOOOOO~      .Z
 .OOOOOOO.         .OOOOOO.OZZ..OOOOOOOOO.      .?O
  .OOOOOI.        .OOOOOOO..,ZOOOOOOOOOO..      .O.
   .OOOOZ.      ..ZOOOOOOOOOOOOOOOOOOOO~        .O.
   .OOOOO= .....ZOOOOOOOOOOOOOOOOOOOOOO.      ..O.
   ..OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOZ       .,OO.
    .ZOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.     ...OO..
     .OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.   ...OO.
     ..ZOOOOOOOOOOOOOOOOOOOOOOOOOOOO.... OZO..
      ...OOOOOOOOOOOOOOOOOOOOOOOOOOZOOOZO...
          .....~OOOOOOOOOOOOOOOOO:........
                ................
--></head><body id='blog'><header id='mobile-header'><div class='wrap'><a class='header-logo' href='/'>DockYard</a><div class='menu-button'></div></div><ul class='flexnav' data-breakpoint='481' id='mobile-nav'><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com'><span class='mobile-nav-icon fontello'>h</span><p class='main-nav-item'>Home</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com'><span class='mobile-nav-icon fontello'>w</span><p class='main-nav-item'>Work</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com'><span class='mobile-nav-icon fontello'>p</span><p class='main-nav-item'>Team</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com'><span class='mobile-nav-icon fontello'>c</span><p class='main-nav-item'>Community</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='/'><span class='mobile-nav-icon fontello'>b</span><p class='main-nav-item'>Blog</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com/hire-us'><span class='mobile-nav-icon fontello'>m</span><p class='main-nav-item'>Contact</p></a></li></ul></header><header id='site-header'><div class='wrap'><h1><a class='header-logo' href='http://dockyard.com'>DockYard</a></h1><ul class='main-nav'><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/work'>Work</a></li><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/team'>Team</a></li><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/community'>Community</a></li><li class='nav-work'><a class='main-nav-item current' href='/'>Blog</a></li><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/contact'>Contact</a></li></ul></div></header><section id='content'><section id='post'><aside class='post-metas-wrap'><ul class='post-metas'><li class='post-meta'><a class="post-author" href="/authors/dan-mcclain.html">Dan McClain</a></li><li class='post-meta'><span><a class='link link-in-post fontello' href='http://twitter.com/_danmcclain' target='_blank'>t</a><a class='link link-in-post fontello' href='https://github.com/danmcclain' target='_blank'>g</a></span></li><li class='post-meta post-date'>05 Mar 2012</li></ul></aside><div class='post-div'><p class='post-meta post-tags'><a class="tag-link" href="/categories/ruby.html">Ruby (35)</a>, <a class="tag-link" href="/categories/testing.html">Testing (6)</a>, <a class="tag-link" href="/categories/linux.html">Linux (1)</a><a class="tag-link" style="float: right" href="/categories.html">See all categories</a></p><div class='post-title-wrap'><h1 class='post-title'>Our Continuous Integration Setup</h1></div><current_page class='post-content'><p>When I started at DockYard, Brian tasked me with setting up a continous
integration (CI) server so that we could keep an eye on our RSpec test
suite. We went with Jenkins since we are writing client code, so
<a href="http://travis-ci.org">travis-ci.org</a> is out of the question (for now).</p>

<p>Our CI server is running on Ubuntu 10.04. We are using nginx as a
reverse proxy infront of our Jenkins server. Our basic setup is the same
as <a href="http://bostonrb.org/presentations/jenkins-rails">the presentation I gave at Boston RB in January</a>.
There are a few upgrades I have made since then.  First, I set up the
GitHub authentication plugin. The other plugin I installed was the
Campfire notification plugin. Since we are all remote, we use Campfire
as our main line of communication. Having Jenkins notify us in Campfire
allows us to see when new code is pushed to master, and when someone
breaks the build.</p>

<h2>RSpec HTML formatter + Jenkins = Every Build is successful (even when it isn&#39;t)</h2>

<p>As we found out the hard way, using the RSpec HTML formatter from within
jenkins is not the best idea.  The problem is the HTML formatter returns
the same exit code regardless of whether or not the suite passes. This
is a huge problem, as you end up with false positives.</p>

<h2>Enter ci_reporter</h2>

<p>The <a href="https://github.com/nicksieger/ci_reporter">ci_reporter</a> gem provides a rake
task that generates a set of xml reports that Jenkins can interpret and
give us a more complete picture of our test suite. Jenkins will plot the
number of failure over time, display test duration, and provide a number 
of other stats you can utilize. </p>

<h2>Capybara-webkit + Xvfb + headless = Javascript without opening a browser</h2>

<p>We are using capybara to run our <a href="http://railscasts.com/episodes/257-request-specs-and-capybara">request
specs</a>.
When our request spec needs javascript, we use 
<a href="https://github.com/thoughtbot/capybara-webkit">Capybara-webkit</a> as our
javascript driver. Capybara-webkit is a
webkit capybara driver, allowing you to run javascript in a headless
webkit instance.  It accomplishes this by using QtWebKit. On Ubuntu, to
utilize capybara-webkit, you need an X Server running when you run your
test.  To accomplish this, I installed Xvfb, which will create a
virtual framebuffer.  To instantiate xvfb, I used the headless
gem, which is a ruby wrapper for xvfb.  With headless, I don&#39;t have to
do any bash scripting to get a framebuffer ready before we run our
tests. </p>

<p>I added the following code to our <code>spec_helper.rb</code> file</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
</pre></td>
  <td class="code"><pre>config.before(<span class="symbol">:suite</span>) <span class="keyword">do</span>
  <span class="instance-variable">@headless</span> = <span class="constant">Headless</span>.new
  <span class="instance-variable">@headless</span>.start
<span class="keyword">end</span>

config.after(<span class="symbol">:suite</span>) <span class="keyword">do</span>
  <span class="instance-variable">@headless</span>.destroy
<span class="keyword">end</span>
</pre></td>
</tr></table>
</div></div>
<p>The above spippet creates the headless instance and creates the
framebuffer at the beginning of the test suite, and destorys it
afterwards.</p>

<h2>Conclusion</h2>

<p>Overall, I&#39;m pretty happy with our set up as it is. The one issue I have
with it is the way ci_reporter and jenkins interact. Since Jenkins was
origianlly built for Java, builds are BROKEN when they don&#39;t build, but
UNSTABLE when their tests fail.  UNSTABLE builds are seen as successful.
I would rather an UNSTABLE build be seen as a failure, since the
campfire notification plugin plays the same sound for successful and
unstable builds.  I may poke around with the plugin or ci_reporter to
have jenkins notify us of builds in a way that makes more sense.</p>
</current_page><p class='issue'>See a problem with the current page? &nbsp;<a href='https://github.com/dockyard/reefpoints/blob/master/source/posts/' target='_blank'>Send a pull request to contribute, we'll happily accept!</a></p><section class='post-share'><h1>Like the current page? Please share!</h1><div class='social-button'><a class='twitter-share-button' data-url='http://reefpoints.dockyard.com/ruby/2012/03/05/our-ci-setup.html' data-via='DockYard' href='https://twitter.com/share'>Tweet</a></div><script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='//platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','twitter-wjs');
</script><div class='social-button'><div class='g-plusone' data-href='#' data-size='medium' data-width='100'></div><script>
  (function() {var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;po.src = 'https://apis.google.com/js/plusone.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);})();
</script></div></section><section id='post-comments'><div id='disqus_thread'></div><script>
  var disqus_shortname = 'reefpoints';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script><noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a></noscript></noscript></section></div></section><script>
  var path = window.location.pathname.split('/').reverse();
  var postname = path[0].split('.');
  var change = postname[0] + '.md';
  var newpath = 'https://github.com/dockyard/reefpoints/blob/master/source/posts/' + path[3] + '-' + path[2] + '-' + path[1] + '-' + change
  $('.issue a').attr('href', newpath);
</script>
</section><footer><ul class='footer-links'><li><a class='link link-in-footer fontello' href='https://github.com/DockYard' target='_blank'>g</a></li><li><a class='link link-in-footer fontello' href='https://twitter.com/DockYard' target='_blank'>t</a></li><li><a class='link link-in-footer fontello' href='http://reefpoints.dockyard.com/atom.xml' target='_blank'>r</a></li><li><a class='link link-in-footer fontello' href='http://dockyard.com/hire-us' target='_blank'>m</a></li></ul><form class='footer-form'><label class='footer-form-label'>Get in touch with us!</label><input class='footer-form-input' placeholder='Email' type='text'><button class='footer-form-submit fontello' href='http://dockyard.com/contact'>R</button></form><a class='footer-number' href='tel:855-362-5973'>(855) DOCK-YRD</a><p class='footer-copyright'>&copy; 2013 DockYard, LLC. All Rights Reserved.</p></footer><audio class='foghorn' preload='auto' src='/sound/foghorn.mp3'></audio><script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'reefpoints'; // required: replace example with your forum shortname
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script></body></html>
