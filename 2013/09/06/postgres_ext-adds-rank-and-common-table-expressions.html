<!DOCTYPE html><html><head><title>Postgres_ext adds rank and common table expressions</title><link href="/stylesheets/all-e2d18991.css" media="screen" rel="stylesheet" type="text/css" /><script src="/javascripts/all-c96a81f7.js" type="text/javascript"></script><meta content='NO-CACHE' http-equiv='CACHE-CONTROL'><meta content='DockYard is a Ruby on Rails, PostgreSQL, and, Ember.js, web / mobile application development software consultancy based in Boston, MA.' namer='description'><meta content='ruby on rails, rails, ruby, ruby on rails training, ruby application development, ruby on rails application development, ember application development, ember.js application development, software application development, web, web application development, mobile, mobile application development, ios, ios application development, iphone, iphone application development, android, android application development, postgres, startups, enterprise, Boston, MA, Massachusetts, for hire' name='keywords'><meta content='web development, mobile development, startups, enterprise, ruby on rails, rails, ruby, ruby on rails training, Boston, for hire' name='keywords'><meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0' name='viewport'><meta charset='utf-8'><meta content='DockYard.com - In postgres_ext 2.1, complex queries get much easier' name='description'><link href='https://plus.google.com/102648938707671188640' rel='author'><meta content='_danmcclain' name='twitter:creator'><meta content='summary' name='twitter:card'><meta content='@DockYard' name='twitter:site'><meta content='http://reefpoints.dockyard.com/2013/09/06/postgres_ext-adds-rank-and-common-table-expressions.html' name='twitter:url'><meta content='Postgres_ext adds rank and common table expressions' name='twitter:title'><meta content='In postgres_ext 2.1, complex queries get much easier' name='twitter:description'><link href='//cloud.typography.com/6496052/702882/css/fonts.css' rel='stylesheet' type='text/css'><link href='http://dockyard.com/humans.txt' rel='author'><link href='/favicon-573a5e34.png' rel='shortcut icon' type='image/x-icon'><link href='/favicon-573a5e34.png' rel='icon' type='image/x-icon'><link href='/apple-touch-icon.png' rel='apple-touch-icon'><link href='/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'><script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24185112-2']);
    _gaq.push(['_trackPageview']);
  
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
<!--
                                             ..
                                           .O.
                                       .:OO.
                                      :OOO.
                                    :OOO:.
                         ...      :OOOO:
                   ..ZOOOOOOOOO..OZ.O.
                   OOOOOOOOOOOOOOOOI
                  OOOOOOOOOOOOOOOOI,
                 OOOOOOOO. .OOOOOOOO:
                 OOOOOOOO   OOOOOOOOO:
                OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO:
               .OOOOOOOOOOOOOOOOOOOOO.
                OOOOOOOOOOOOOOOOOOOOO
                OOOOOO?:   .OOOOOOOOO
               .OOOOO      OOOOOOOOOO
,OO ZO~        OOOOO,     OOOOOOOOOO+
 OOOOO.        OOOOO     OOOOOOOOOOO+
  OOO?        OOOOO     .OOOOOOOOOOO:
   OOO,      OOOOO.    .OOOOOOOOOOOO
    OOOOOOOOOOOOO.    .OOOOOOOOOOOO.
     OOOOOOOOOOOO.  .OOOOOOOOOOOOO.
      8OOOOOOOOOOOOOOOOOOOOOOOODO:
         :OOOOOOOOOOOOOOOOOOOO::

--></head><body class='x2013 x2013_09 x2013_09_06 x2013_09_06_postgres_ext-adds-rank-and-common-table-expressions'><header><div class='extended-header-wrap has-border--bottom'><div class='l-wrap--wide'><nav class='extended-nav has-border--bottom'><a class='extended-nav--logo' data-icon='⌂' href='http://dockyard.com/'><span class='is-hidden'>Home</span></a><a class='extended-nav--close' data-icon='X'><span class='is-hidden'>Close</span></a><div class='extended-nav__items-wrap'><div class='extended-nav__items'><a class='extended-nav__item' href='http://dockyard.com/team'>Our Team</a><a class='extended-nav__item' href='http://dockyard.com/community'>Community</a><a class='extended-nav__item active' href='/'>Blog</a><a class='extended-nav__item' href='http://dockyard.com/hire-us'>Hire Us</a></div></div></nav><nav class='work-nav'><p>Selected Work</p><a class='work-nav-item' href='http://dockyard.com/work/credit-card-reviews'><h4 class='work-nav-item__title'>Credit Card Reviews</h4><p class='work-nav-item__desc'>Credit card advice from real people.</p></a><a class='work-nav-item' href='http://dockyard.com/work/coachup'><h4 class='work-nav-item__title'>CoachUp</h4><p class='work-nav-item__desc'>You should be training. Right now.</p></a><a class='work-nav-item' href='http://dockyard.com/work/askthem'><h4 class='work-nav-item__title'>AskThem</h4><p class='work-nav-item__desc'>Ask officials questions on city, state, and federal levels.</p></a><a class='work-nav-item' href='http://dockyard.com/work/beacon-hill-blitz'><h4 class='work-nav-item__title'>Beacon Hill Blitz</h4><p class='work-nav-item__desc'>How technology helped repeal the #TechTax.</p></a></nav></div></div><nav class='main-nav-wrap has-border--bottom'><div class='main-nav l-wrap--wide'><a class='logo' href='http://dockyard.com'>DockYard</a><a class='club-sandwich' data-icon='☰'><span class='is-hidden'>Navigation</span></a></div></nav></header><div class='push--header'></div><div class='l-wrap'><a class='logo--reefpoints' href='/'>ReefPoints</a><div class='search-wrap'><form class='search' data-url='/'><input class='search__input' id='search' name='search' placeholder='Search all posts' type='text' value=''><button class='search__submit' href='/'></button></form></div><nav class='blog-topnav'><a class="blog-topnav__item " href="/">Posts</a><a class="blog-topnav__item " href="/tags.html">Tags</a><a class="blog-topnav__item " href="/authors.html">Authors</a></nav><div class='post-wrap--no-comments'><aside class='post__metas--post l-post__metas'><a class='icon' data-icon='#' href='http://twitter.com/_danmcclain' target='_blank'><span class='is-hidden'>Twitter</span></a><a class='icon' data-icon='★' href='https://github.com/danmcclain' target='_blank'><span class='is-hidden'>GitHub</span></a><a class="post__meta--author" href="/authors/dan-mcclain.html">Dan McClain</a><p class='post__meta--date'>06 Sep 2013</p><p class='post__meta--tags'><a class="post__meta--tag" href="/tags/ruby-on-rails.html">Ruby on Rails (25)</a> <a class="post__meta--tag" href="/tags/gems.html">Gems (10)</a> <a class="post__meta--tag" href="/tags/postgres_ext.html">Postgres_ext (2)</a> <a class="post__meta--tag" href="/tags/postgresql.html">PostgreSQL (9)</a></p></aside><div class='post l-post'><h1 class='post__title'>Postgres_ext adds rank and common table expressions</h1><current_page class='post__content'><p>This week, I released <a href="https://github.com/dockyard/postgres_ext">postgres_ext</a> 2.1.0, which includes
ActiveRecord::Relation methods to simplify queries that require the use
of <a href="http://www.postgresql.org/docs/current/static/queries-with.html">Common Table
Expressions</a>
(CTEs) and the <a href="http://www.postgresql.org/docs/9.2/static/functions-window.html"><code>rank()</code> windowing
function</a>.</p>

<h2>Common Table Expressions</h2>

<p>In a sentence, CTEs allow you to define a temporary table to be used in
a larger query. Let&#39;s look at an example:</p>
<div class="highlight SQL "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
</pre></td>
  <td class="code"><pre>WITH scores_for_game <span class="keyword">AS</span> (
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> scores
<span class="keyword">WHERE</span> game_id = <span class="integer">1</span>
)
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> scores_for_game
</pre></td>
</tr></table>
</div></div>
<p>In the above, somewhat arbitrary, example, we create a temporary table
of <code>scores_for_game</code> which we then select from. CTEs allow you to
organize your more complex queries, and can be really helpful in certain
cases.</p>

<p>We can make the same SQL call in ActiveRecord with postgres_ext.</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre><span class="constant">Score</span>.from_cte(<span class="string"><span class="delimiter">'</span><span class="content">scores_for_game</span><span class="delimiter">'</span></span>, <span class="constant">Score</span>.where(<span class="key">game_id</span>: <span class="integer">1</span>))
</pre></td>
</tr></table>
</div></div>
<p>We can also query against the CTE expression by chaining off the
resulting ActiveRecord::Relation</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre><span class="constant">Score</span>.from_cte(<span class="string"><span class="delimiter">'</span><span class="content">scores_for_game</span><span class="delimiter">'</span></span>,
  <span class="constant">Score</span>.where(<span class="key">game_id</span>: <span class="integer">1</span>)).where(<span class="key">user_id</span>: <span class="integer">1</span>)
</pre></td>
</tr></table>
</div></div>
<p>would generate the following:</p>
<div class="highlight SQL "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
</pre></td>
  <td class="code"><pre>WITH scores_for_game <span class="keyword">AS</span> (
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> scores
<span class="keyword">WHERE</span> game_id = <span class="integer">1</span>
)
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> scores_for_game
<span class="keyword">WHERE</span> scores_for_game.user_id = <span class="integer">1</span>
</pre></td>
</tr></table>
</div></div>
<p>You can also include CTEs in your normal queries to join against by
using <code>with</code></p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre><span class="constant">Score</span>.with(<span class="key">my_games</span>: <span class="constant">Game</span>.where(<span class="key">id</span>: <span class="integer">1</span>)).joins(<span class="string"><span class="delimiter">'</span><span class="content">JOIN my_games ON scores.game_id = my_games.id</span><span class="delimiter">'</span></span>)
</pre></td>
</tr></table>
</div></div>
<p>will generate the following SQL:</p>
<div class="highlight SQL "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre>WITH my_games <span class="keyword">AS</span> (
<span class="class">SELECT</span> games.*
<span class="keyword">FROM</span> games
<span class="keyword">WHERE</span> games.id = <span class="integer">1</span>
)
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> scores
<span class="keyword">JOIN</span> my_games
<span class="keyword">ON</span> scores.games_id = my_games.id
</pre></td>
</tr></table>
</div></div>
<h2>Rank</h2>

<p>PostgreSQL provides a <code>rank</code> windowing function, which will take into
account ties when ranking results. You would add rank to your
projection, like the following example:</p>
<div class="highlight SQL "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre><span class="class">SELECT</span> scores.*, rank() <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> scores.points <span class="directive">DESC</span>)
<span class="keyword">FROM</span> scores
</pre></td>
</tr></table>
</div></div>
<p>The results set will return ordered by the rank, which is determined the
order passed into the <code>rank</code>&#39;s <code>OVER</code>. In the above example, the scores
would be ranked by their scores descending, so highest score first. If
there was a tie at first place between two scores, they would both
ranked 1, and the next result would be ranked <code>3</code>. We can achieve the
same in ActiveRecord with postgres_ext:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre><span class="constant">Score</span>.ranked(<span class="key">points</span>: <span class="symbol">:desc</span>)
<span class="comment"># or</span>
<span class="constant">Score</span>.ranked(<span class="string"><span class="delimiter">'</span><span class="content">points desc</span><span class="delimiter">'</span></span>)
</pre></td>
</tr></table>
</div></div>
<p>Rank will rank independently of any sort order applied to the query, so
you could have your scores ranked by points, but then ordered by their
creation time.</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre><span class="constant">Score</span>.ranked(<span class="key">points</span>: <span class="symbol">:desc</span>).order(<span class="symbol">:created_at</span>)
</pre></td>
</tr></table>
</div></div>
<p>will generate the following query:</p>
<div class="highlight sql "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre><span class="class">SELECT</span> scores.*, rank() <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> scores.points <span class="directive">DESC</span>)
<span class="keyword">FROM</span> scores
<span class="keyword">ORDER</span> <span class="keyword">BY</span> scores.created_at <span class="directive">ASC</span>
</pre></td>
</tr></table>
</div></div>
<p>Also, if you apply a sort order to your relation, and want to sort by
it, you do not have to tell ranked what order you&#39;d like to use, as it
will reuse the order. </p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre><span class="constant">Score</span>.ranked.order(<span class="key">points</span>: <span class="symbol">:desc</span>)
</pre></td>
</tr></table>
</div></div>
<p>One thing to watch out for if you use <code>ranked</code> without an explicit
order and want to call <a href="http://api.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-first"><code>first</code></a>
off your relation, if the results of the
relation have yet to be retrieved, the first will use your table&#39;s
primary key for an <code>ORDER BY</code> statement on the query. This has already
bitten us before we discovered the behavior of <code>first</code>. To avoid this
behavior in <code>first</code>, use
<a href="http://api.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-take"><code>take</code></a>
which does not use any implied order.</p>

<p>We&#39;ve been using CTEs and rank on one of our client projects, and it&#39;s
already cleaned up the <code>from_sql</code> queries we were previously
using. Let us know if you hit any snags, or have any suggestions on how
else we can make complex SQL queries easier to call from ActiveRecord!
We only implement the <code>rank</code> windowing function right now, but plan to
add the others shortly.</p>
<div class='post__share'><div class='post__share__links'><a class='twitter-share-button' data-url='http://reefpoints.dockyard.com/2013/09/06/postgres_ext-adds-rank-and-common-table-expressions.html' data-via='DockYard' href='https://twitter.com/share'>Tweet</a><script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='//platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','twitter-wjs');
</script><div class='g-plusone' data-href='#' data-size='medium' data-width='100'></div><script>
  (function() {var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;po.src = 'https://apis.google.com/js/plusone.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);})();
</script></div><p>This article is brought to you by <a class='text-link' href='http://dockyard.com/'>DockYard</a>. If you see an issue, please send a <a href='https://github.com/dockyard/reefpoints/blob/master/source/posts/', class='text-link post__issue', target: '_blank'>pull request</a> to contribute.</p><a class='button--post' href='http://dockyard.com/hire-us'>Hire Us</a></div></current_page></div></div><div class='post__comments'><div id='disqus_thread'></div><script>
  var disqus_shortname = 'reefpoints';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script><noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus</a>.</noscript></noscript></div><script>
  var path = window.location.pathname.split('/').reverse();
  var postname = path[0].split('.');
  var change = postname[0] + '.md';
  var newpath = 'https://github.com/dockyard/reefpoints/blob/master/source/posts/' + path[3] + '-' + path[2] + '-' + path[1] + '-' + change
  $('.post__issue').attr('href', newpath);
  
  $('.search').submit(function(event) {
    event.preventDefault();
    window.location = $(this).data('url') + '#q=' + $('.search__input').val();
  });
</script>
<h2 class='nothin'>Your search returned no results. Perhaps you should try again.</h2></div><div class='push--big'></div><footer><div class='l-wrap'><div class='footer-group'><h3 class='footer-group__title'>EVENTS</h3><nav><a class='footer__event' href='http://wickedgoodruby.com/' target='_blank'><div class='footer__event--wgr'></div><h4 class='footer-title'>Wicked Good Ruby Conf</h4></a><a class='footer__event' href='http://www.meetup.com/Boston-Ember-js/' target='_blank'><div class='footer__event--ember'></div><h4 class='footer-title'>Boston Ember.js Meetup</h4></a><a class='footer__event' href='http://www.meetup.com/uxboston/' target='_blank'><div class='footer__event--ux'></div><h4 class='footer-title'>UX Boston Meetup</h4></a><a class='footer__event' href='http://openhack.github.io/boston/' target='_blank'><div class='footer__event--openhack'></div><h4 class='footer-title'>OpenHack Boston</h4></a></nav></div><div class='footer-group'><a href='/'><h3 class='footer-group__title'>BLOG</h3></a><nav class='blog-nav--footer'><a class='blog-nav-item--footer' href='/2013/12/08/introducing-easydir-vim.html'><h4 class='footer-title'>Introducing easydir.vim</h4><p class='footer-desc'>A Vim plugin that allows you create directories and files at the same time!</p></a><a class='blog-nav-item--footer' href='/2013/12/06/always-be-exploring.html'><h4 class='footer-title'>Never Stop Exploring</h4><p class='footer-desc'>Being true to yourself and creating passionate work.</p></a><a class='blog-nav-item--footer' href='/2013/11/27/vim-windows.html'><h4 class='footer-title'>Buffers, Windows, Tabs... Oh My! Part 2: Vim Windows</h4><p class='footer-desc'>A painless tutorial on Vim windows</p></a></nav></div><div class='footer-group'><a href='/hire-us'><h3 class='footer-group__title'>CONTACT</h3></a><p class='footer-desc'>DockYard HQ is located in Boston. Stop in sometime and meet our team!</p><a class='footer-address has-border--top' href='https://www.google.com/maps/preview#!q=DockYard%2C+Tremont+Street+%23200%2C+Boston%2C+MA&amp;data=!4m15!2m14!1m13!1s0x89e37083512ceab3%3A0x1e657c639844318d!3m8!1m3!1d197180!2d-70.970284!3d42.31435!3m2!1i400!2i802!4f13.1!4m2!3d42.357236!4d-71.061077' target='_blank'><p class='footer-desc'>DockYard Inc.</p><p class='footer-desc'>101 Tremont Street</p><p class='footer-desc'>Suite 200</p><p class='footer-desc'>Boston, MA 02108</p></a><a class="text-link" href="http://dockyard.com/hire-us">Get in touch.</a><div class='footer-social has-border--top'><a class='social-nav-item' data-icon='#' href='https://twitter.com/dockyard' target='_blank'><span class='is-hidden'>Twitter</span></a><a class='social-nav-item' data-icon='★' href='https://github.com/dockyard' target='_blank'><span class='is-hidden'>GitHub</span></a><a class='social-nav-item' data-icon='✒' href='http://reefpoints.dockyard.com/atom.xml' target='_blank'><span class='is-hidden'>RSS</span></a></div></div></div></footer><audio class='foghorn' preload='auto' src='/sound/foghorn.mp3'></audio><script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'reefpoints'; // required: replace example with your forum shortname
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script></body></html>
