<!DOCTYPE html><html><head><title>Postgres_ext adds rank and common table expressions</title><link href="/stylesheets/all-f0f513e0.css" media="screen" rel="stylesheet" type="text/css" /><script src="/javascripts/all-d0af4672.js" type="text/javascript"></script><meta content='NO-CACHE' http-equiv='CACHE-CONTROL'><meta content='DockYard is a Ruby on Rails, PostgreSQL, and, Ember.js, web / mobile application development software consultancy based in Boston, MA.' namer='description'><meta content='ruby on rails, rails, ruby, ruby on rails training, ruby application development, ruby on rails application development, ember application development, ember.js application development, software application development, web, web application development, mobile, mobile application development, ios, ios application development, iphone, iphone application development, android, android application development, postgres, startups, enterprise, Boston, MA, Massachusetts, for hire' name='keywords'><meta content='web development, mobile development, startups, enterprise, ruby on rails, rails, ruby, ruby on rails training, Boston, for hire' name='keywords'><meta content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0' name='viewport'><meta content='DockYard.com - In postgres_ext 2.1, complex queries get much easier' name='description'><meta content=' danmcclain' name='twitter:creator'><meta content='summary' name='twitter:card'><meta content='@DockYard' name='twitter:site'><meta content='http://reefpoints.dockyard.com/2013/09/06/postgres_ext-adds-rank-and-common-table-expressions.html' name='twitter:url'><meta content='Postgres_ext adds rank and common table expressions' name='twitter:title'><meta content='In postgres_ext 2.1, complex queries get much easier' name='twitter:description'><link href='http://dockyard.com/humans.txt' rel='author'><link href='/apple-touch-icon.png' rel='apple-touch-icon'><link href='/apple-touch-icon-precomposed.png' rel='apple-touch-icon-precomposed'><script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24185112-2']);
    _gaq.push(['_trackPageview']);
  
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
<!--
                                                                    ..
                                                                 ,Z+O.
                                                              .OO.O..
                                                             OZ..O.
                                                         ..OO..87.
                                                        .O7O..O...
                                                      .O...Z~O.
                                                   .:Z~. ..Z..
                                                  +O.O   .8..
                                     ...       .OO.  O  O?.
                             ..ZOOOOOOOOOZOOO.ZOZ.   .OO..
                           .OOOOOOOOOOOOOOOOOO..Z.   $O.
                         .ZOOOOOOOOOOOOOOOOOO.  .O..O.
                        .ZOOOOOOOOOOOOOOOOOOOZ  .:O$.
                        OZOOOOOOOOOOO...OOOOOOOZ$ZO
                      ..OOOOOOOOOOOOO  .OOOOOOOOOOO..
                      .OOOOOOOOOOOOOOOOOOOOOOOOOOOOO.
                      .OOOOOOOOOOOOOOOOOOOOOOOOOOOOZ.
                      OOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.
                     .OOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.
                     :OOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.
                     ZOOOOOOOOOOOOOOOOOOOOOOOOOOOOOZ.
                     OOOOOOOOOOOOOOOOOOOOOOOOOOOO7OO.
                     ZOOOOOOOOOOOOOOOOOOOOOOOOOOOOOZ.
                     OOOOOOZOOOOOOOO.ZOOOOOOOOOOO7OO.
                     ZOOOOO.OOOOOOOO.OOOOOOOOOO.  OO.
...     ..           OOOOO.OOOOOOOO.OOOOOOOOO.   .O:
.OOZ...OOO.        ..OOOOO.OOOOOOO.OOOOOOOOZ.    .Z..
.OOOOOOOOO         .ZOOOOO.OOOOO..OOOOOOOO~      .Z
 .OOOOOOO.         .OOOOOO.OZZ..OOOOOOOOO.      .?O
  .OOOOOI.        .OOOOOOO..,ZOOOOOOOOOO..      .O.
   .OOOOZ.      ..ZOOOOOOOOOOOOOOOOOOOO~        .O.
   .OOOOO= .....ZOOOOOOOOOOOOOOOOOOOOOO.      ..O.
   ..OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOZ       .,OO.
    .ZOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.     ...OO..
     .OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO.   ...OO.
     ..ZOOOOOOOOOOOOOOOOOOOOOOOOOOOO.... OZO..
      ...OOOOOOOOOOOOOOOOOOOOOOOOOOZOOOZO...
          .....~OOOOOOOOOOOOOOOOO:........
                ................
--></head><body id='blog'><header id='mobile-header'><div class='wrap'><a class='header-logo' href='/'>DockYard</a><div class='menu-button'></div></div><ul class='flexnav' data-breakpoint='481' id='mobile-nav'><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com'><span class='mobile-nav-icon fontello'>h</span><p class='main-nav-item'>Home</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com'><span class='mobile-nav-icon fontello'>w</span><p class='main-nav-item'>Work</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com'><span class='mobile-nav-icon fontello'>p</span><p class='main-nav-item'>Team</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com'><span class='mobile-nav-icon fontello'>c</span><p class='main-nav-item'>Community</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='/'><span class='mobile-nav-icon fontello'>b</span><p class='main-nav-item'>Blog</p></a></li><li class='mobile-nav-link-wrap'><a class='mobile-nav-link' href='http://dockyard.com/hire-us'><span class='mobile-nav-icon fontello'>m</span><p class='main-nav-item'>Contact</p></a></li></ul></header><header id='site-header'><div class='wrap'><h1><a class='header-logo' href='http://dockyard.com'>DockYard</a></h1><ul class='main-nav'><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/work'>Work</a></li><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/team'>Team</a></li><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/community'>Community</a></li><li class='nav-work'><a class='main-nav-item current' href='/'>Blog</a></li><li class='nav-work'><a class='main-nav-item' href='http://dockyard.com/contact'>Contact</a></li></ul></div></header><section id='content'><section id='post'><aside class='post-metas-wrap'><ul class='post-metas'><li class='post-meta'><a class="post-author" href="/authors/dan-mcclain.html">Dan McClain</a></li><li class='post-meta'><span><a class='link link-in-post fontello' href='http://twitter.com/ danmcclain' target='_blank'>t</a><a class='link link-in-post fontello' href='https://github.com/danmcclain' target='_blank'>g</a></span></li><li class='post-meta post-date'>06 Sep 2013</li></ul></aside><div class='post-div'><p class='post-meta post-tags'><a class="tag-link" href="/categories/ruby-on-rails.html">Ruby on Rails (25)</a>, <a class="tag-link" href="/categories/gems.html">Gems (10)</a>, <a class="tag-link" href="/categories/postgres_ext.html">Postgres_ext (2)</a>, <a class="tag-link" href="/categories/postgresql.html">PostgreSQL (9)</a><a class="tag-link" style="float: right" href="/categories.html">See all categories</a></p><div class='post-title-wrap'><h1 class='post-title'>Postgres_ext adds rank and common table expressions</h1></div><current_page class='post-content'><p>This week, I released <a href="https://github.com/dockyard/postgres_ext">postgres_ext</a> 2.1.0, which includes
ActiveRecord::Relation methods to simplify queries that require the use
of <a href="http://www.postgresql.org/docs/current/static/queries-with.html">Common Table
Expressions</a>
(CTEs) and the <a href="http://www.postgresql.org/docs/9.2/static/functions-window.html"><code>rank()</code> windowing
function</a>.</p>

<h2>Common Table Expressions</h2>

<p>In a sentence, CTEs allow you to define a temporary table to be used in
a larger query. Let&#39;s look at an example:</p>
<div class="highlight SQL "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
</pre></td>
  <td class="code"><pre>WITH scores_for_game <span class="keyword">AS</span> (
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> scores
<span class="keyword">WHERE</span> game_id = <span class="integer">1</span>
)
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> scores_for_game
</pre></td>
</tr></table>
</div></div>
<p>In the above, somewhat arbitrary, example, we create a temporary table
of <code>scores_for_game</code> which we then select from. CTEs allow you to
organize your more complex queries, and can be really helpful in certain
cases.</p>

<p>We can make the same SQL call in ActiveRecord with postgres_ext.</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre><span class="constant">Score</span>.from_cte(<span class="string"><span class="delimiter">'</span><span class="content">scores_for_game</span><span class="delimiter">'</span></span>, <span class="constant">Score</span>.where(<span class="key">game_id</span>: <span class="integer">1</span>))
</pre></td>
</tr></table>
</div></div>
<p>We can also query against the CTE expression by chaining off the
resulting ActiveRecord::Relation</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre><span class="constant">Score</span>.from_cte(<span class="string"><span class="delimiter">'</span><span class="content">scores_for_game</span><span class="delimiter">'</span></span>,
  <span class="constant">Score</span>.where(<span class="key">game_id</span>: <span class="integer">1</span>)).where(<span class="key">user_id</span>: <span class="integer">1</span>)
</pre></td>
</tr></table>
</div></div>
<p>would generate the following:</p>
<div class="highlight SQL "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
</pre></td>
  <td class="code"><pre>WITH scores_for_game <span class="keyword">AS</span> (
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> scores
<span class="keyword">WHERE</span> game_id = <span class="integer">1</span>
)
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> scores_for_game
<span class="keyword">WHERE</span> scores_for_game.user_id = <span class="integer">1</span>
</pre></td>
</tr></table>
</div></div>
<p>You can also include CTEs in your normal queries to join against by
using <code>with</code></p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre><span class="constant">Score</span>.with(<span class="key">my_games</span>: <span class="constant">Game</span>.where(<span class="key">id</span>: <span class="integer">1</span>)).joins(<span class="string"><span class="delimiter">'</span><span class="content">JOIN my_games ON scores.game_id = my_games.id</span><span class="delimiter">'</span></span>)
</pre></td>
</tr></table>
</div></div>
<p>will generate the following SQL:</p>
<div class="highlight SQL "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre>WITH my_games <span class="keyword">AS</span> (
<span class="class">SELECT</span> games.*
<span class="keyword">FROM</span> games
<span class="keyword">WHERE</span> games.id = <span class="integer">1</span>
)
<span class="class">SELECT</span> *
<span class="keyword">FROM</span> scores
<span class="keyword">JOIN</span> my_games
<span class="keyword">ON</span> scores.games_id = my_games.id
</pre></td>
</tr></table>
</div></div>
<h2>Rank</h2>

<p>PostgreSQL provides a <code>rank</code> windowing function, which will take into
account ties when ranking results. You would add rank to your
projection, like the following example:</p>
<div class="highlight SQL "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre><span class="class">SELECT</span> scores.*, rank() <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> scores.points <span class="directive">DESC</span>)
<span class="keyword">FROM</span> scores
</pre></td>
</tr></table>
</div></div>
<p>The results set will return ordered by the rank, which is determined the
order passed into the <code>rank</code>&#39;s <code>OVER</code>. In the above example, the scores
would be ranked by their scores descending, so highest score first. If
there was a tie at first place between two scores, they would both
ranked 1, and the next result would be ranked <code>3</code>. We can achieve the
same in ActiveRecord with postgres_ext:</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre><span class="constant">Score</span>.ranked(<span class="key">points</span>: <span class="symbol">:desc</span>)
<span class="comment"># or</span>
<span class="constant">Score</span>.ranked(<span class="string"><span class="delimiter">'</span><span class="content">points desc</span><span class="delimiter">'</span></span>)
</pre></td>
</tr></table>
</div></div>
<p>Rank will rank independently of any sort order applied to the query, so
you could have your scores ranked by points, but then ordered by their
creation time.</p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre><span class="constant">Score</span>.ranked(<span class="key">points</span>: <span class="symbol">:desc</span>).order(<span class="symbol">:created_at</span>)
</pre></td>
</tr></table>
</div></div>
<p>will generate the following query:</p>
<div class="highlight sql "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre><span class="class">SELECT</span> scores.*, rank() <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> scores.points <span class="directive">DESC</span>)
<span class="keyword">FROM</span> scores
<span class="keyword">ORDER</span> <span class="keyword">BY</span> scores.created_at <span class="directive">ASC</span>
</pre></td>
</tr></table>
</div></div>
<p>Also, if you apply a sort order to your relation, and want to sort by
it, you do not have to tell ranked what order you&#39;d like to use, as it
will reuse the order. </p>
<div class="highlight ruby "><div class="ribbon"></div><div class="scroller"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre><span class="constant">Score</span>.ranked.order(<span class="key">points</span>: <span class="symbol">:desc</span>)
</pre></td>
</tr></table>
</div></div>
<p>One thing to watch out for if you use <code>ranked</code> without an explicit
order and want to call <a href="http://api.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-first"><code>first</code></a>
off your relation, if the results of the
relation have yet to be retrieved, the first will use your table&#39;s
primary key for an <code>ORDER BY</code> statement on the query. This has already
bitten us before we discovered the behavior of <code>first</code>. To avoid this
behavior in <code>first</code>, use
<a href="http://api.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-take"><code>take</code></a>
which does not use any implied order.</p>

<p>We&#39;ve been using CTEs and rank on one of our client projects, and it&#39;s
already cleaned up the <code>from_sql</code> queries we were previously
using. Let us know if you hit any snags, or have any suggestions on how
else we can make complex SQL queries easier to call from ActiveRecord!
We only implement the <code>rank</code> windowing function right now, but plan to
add the others shortly.</p>
</current_page><p class='issue'>See a problem with the current page? &nbsp;<a href='https://github.com/dockyard/reefpoints/blob/master/source/posts/' target='_blank'>Send a pull request to contribute, we'll happily accept!</a></p><section class='post-share'><h1>Like the current page? Please share!</h1><div class='social-button'><a class='twitter-share-button' data-url='http://reefpoints.dockyard.com/2013/09/06/postgres_ext-adds-rank-and-common-table-expressions.html' data-via='DockYard' href='https://twitter.com/share'>Tweet</a></div><script>
  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='//platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','twitter-wjs');
</script><div class='social-button'><div class='g-plusone' data-href='#' data-size='medium' data-width='100'></div><script>
  (function() {var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;po.src = 'https://apis.google.com/js/plusone.js';var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);})();
</script></div></section><section id='post-comments'><div id='disqus_thread'></div><script>
  var disqus_shortname = 'reefpoints';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script><noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a></noscript></noscript></section></div></section><script>
  var path = window.location.pathname.split('/').reverse();
  var postname = path[0].split('.');
  var change = postname[0] + '.md';
  var newpath = 'https://github.com/dockyard/reefpoints/blob/master/source/posts/' + path[3] + '-' + path[2] + '-' + path[1] + '-' + change
  $('.issue a').attr('href', newpath);
</script>
</section><footer><ul class='footer-links'><li><a class='link link-in-footer fontello' href='https://github.com/DockYard' target='_blank'>g</a></li><li><a class='link link-in-footer fontello' href='https://twitter.com/DockYard' target='_blank'>t</a></li><li><a class='link link-in-footer fontello' href='http://reefpoints.dockyard.com/atom.xml' target='_blank'>r</a></li><li><a class='link link-in-footer fontello' href='http://dockyard.com/hire-us' target='_blank'>m</a></li></ul><form class='footer-form'><label class='footer-form-label'>Get in touch with us!</label><input class='footer-form-input' placeholder='Email' type='text'><button class='footer-form-submit fontello' href='http://dockyard.com/contact'>R</button></form><a class='footer-number' href='tel:855-362-5973'>(855) DOCK-YRD</a><p class='footer-copyright'>&copy; 2013 DockYard, LLC. All Rights Reserved.</p></footer><audio class='foghorn' preload='auto' src='/sound/foghorn.mp3'></audio><script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'reefpoints'; // required: replace example with your forum shortname
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script></body></html>
